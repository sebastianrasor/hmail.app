#!/bin/sh

read tx

date >>/var/log/paylog
echo "$tx" >>/var/log/paylog

echo "$tx" | jq -r '.outputs | .[] | .address' | while read address; do
	key="$(hsw-cli key "$address")"
	echo "$key" >> /var/log/paylog
	if [ "$key" != "null" ]; then
		account="$(echo "$key" | jq -r '.name')"
		echo "$account" >> /var/log/paylog
		if [ "$(echo "$account" | cut -c 1-6)" = "email_" ]; then
			days="$(echo "$tx" | jq --arg address "$address" '.outputs | .[] | select(.address==$address) | .value / 1000000 * 10 | floor')"
			echo "$days" >> /var/log/paylog
			sqlite3 /var/vmail/_users.sqlite "UPDATE users SET expire=CASE WHEN expire > date('now') THEN (date(expire, '-$days day')) ELSE (date('now', '-$days day')) END WHERE ROWID=$(echo "$account" | cut -c 7-)"
			echo "Your previous payment has been unconfirmed. Your acconut expiration date has been reverted to: $(sqlite3 /var/vmail/_users.sqlite "SELECT expire FROM users WHERE ROWID=$(echo "$account" | cut -c 7-)")" | doas -u vmail mail -s "Payment Error" "$(sqlite3 /var/vmail/_users.sqlite "SELECT user||'@'||domain FROM users WHERE ROWID=$(echo "$account | cut -c 7-)")"
		fi
	fi
done
